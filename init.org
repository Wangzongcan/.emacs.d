#+TITLE: Emacs 26 Configuration
#+STARTUP: align indent
#+PROPERTY: header-args :tangle yes :results value silent

* Speed Up Startup

使用 doom-emacs 的配置

#+BEGIN_SRC emacs-lisp
  (defvar last-file-name-handler-alist file-name-handler-alist)
  (setq gc-cons-threshold 402653184
        gc-cons-percentage 0.6
        file-name-handler-alist nil)

  (add-hook 'emacs-startup-hook
            (lambda ()
              (setq gc-cons-threshold 16777216
                    gc-cons-percentage 0.1
                    file-name-handler-alist last-file-name-handler-alist)))
#+END_SRC

* Package Management

** Package.el

#+BEGIN_SRC emacs-lisp
  (require 'package)

  (setq package-enable-at-startup nil
        package-archives
        '(("gnu"   . "https://elpa.gnu.org/packages/")
          ("melpa" . "https://melpa.org/packages/")))

  (package-initialize)
#+END_SRC

** Setup use-package

#+BEGIN_SRC emacs-lisp
  (unless (package-installed-p 'use-package)
    (package-refresh-contents)
    (package-install 'use-package))

  (eval-when-compile
    (require 'use-package)
    (setq use-package-always-ensure t))

  (use-package general
    :init
    (setq general-override-states '(normal))
    :config
    (general-define-key
     :states '(normal)
     :keymaps 'override
     "SPC" 'hydra-space/body))
#+END_SRC

* Basic Configuration

** Display

#+BEGIN_SRC emacs-lisp
  (blink-cursor-mode -1)

  (setq-default truncate-lines t
                cursor-in-non-selected-windows nil)
#+END_SRC

** Files

*** Auto Save

#+BEGIN_SRC emacs-lisp
  (setq auto-save-default nil
        auto-save-list-file-name nil
        auto-save-list-file-prefix nil)
#+END_SRC

*** Backup

#+BEGIN_SRC emacs-lisp
  (setq backup-inhibited t)
#+END_SRC

*** Lockfile

#+BEGIN_SRC emacs-lisp
  (setq create-lockfiles nil)
#+END_SRC

** Format

#+BEGIN_SRC emacs-lisp
  (setq-default indent-tabs-mode nil)

  (setq require-final-newline t)
#+END_SRC

** GUI Frames

#+BEGIN_SRC emacs-lisp
  (defconst frames-parameters
    '((font . "等距更纱黑体 SC-12")
      (internal-border-width . 0)
      (menu-bar-lines . 0)
      (tool-bar-lines . 0)
      (ns-transparent-titlebar . t)
      (ns-appearance . dark)
      (horizontal-scroll-bars . nil)
      (vertical-scroll-bars . nil)))

  (setq default-frame-alist frames-parameters
        initial-frame-alist frames-parameters
        frame-resize-pixelwise t)

  ;;----------------------------------------------------------------------------
  ;; Suppress GUI features
  ;;----------------------------------------------------------------------------
  (tooltip-mode -1)
  (setq use-dialog-box nil)
#+END_SRC

** Minibuffer

#+BEGIN_SRC emacs-lisp
  (setq echo-keystrokes 0.01
        enable-recursive-minibuffers t)

  (add-hook 'minibuffer-setup-hook
            (lambda()
              (setq gc-cons-threshold most-positive-fixnum)))

  (add-hook 'minibuffer-exit-hook
            (lambda()
              (setq gc-cons-threshold 16777216)))
#+END_SRC

** Path

#+BEGIN_SRC emacs-lisp
  (defconst extra-exec-path
    (list "/usr/local/bin" (expand-file-name ".asdf/shims")))

  (defconst extra-path
    (mapconcat (function (lambda (x) (format "%s:" x))) extra-exec-path ""))

  (setenv "PATH" (concat extra-path (getenv "PATH")))
  (setq-default exec-path (append exec-path extra-exec-path))
#+END_SRC

** Quiet

#+BEGIN_SRC emacs-lisp
  (setq ring-bell-function #'ignore)
#+END_SRC

** Scroll

#+BEGIN_SRC emacs-lisp
  (setq hscroll-margin 1
        hscroll-step 1
        scroll-margin 1
        scroll-conservatively 10000
        scroll-preserve-screen-position t)
#+END_SRC

** Startup

#+BEGIN_SRC emacs-lisp
  (setq initial-major-mode 'fundamental-mode
        inhibit-startup-screen t
        initial-scratch-message "")
#+END_SRC

** Yes or No

#+BEGIN_SRC emacs-lisp
  (fset 'yes-or-no-p 'y-or-n-p)
#+END_SRC

* Built-in Packages
** Auto Revert

#+BEGIN_SRC emacs-lisp
  (use-package autorevert
    :ensure nil
    :hook (after-init . global-auto-revert-mode)
    :config
    (setq auto-revert-interval 0.1
          auto-revert-verbose nil
          global-auto-revert-non-file-buffers t))
#+END_SRC

** Dired

#+BEGIN_SRC emacs-lisp
  (use-package dired
    :ensure nil
    :hook ((dired-mode . dired-omit-mode)
           (dired-mode . dired-hide-details-mode))
    :bind (("C-x C-j" . dired-jump)
           :map dired-mode-map
           ("I" . dired-kill-subdir))
    :config
    (setq dired-dwim-target t
          dired-recursive-copies 'always
          insert-directory-program "gls"
          dired-listing-switches "-aBhl --group-directories-first"))

  (use-package dired-x
    :ensure nil
    :after dired
    :config
    (setq dired-omit-verbose nil
          dired-omit-files
          (concat dired-omit-files "\\|^.DS_Store$")))
#+END_SRC

** Ibuffer

#+BEGIN_SRC emacs-lisp
  (use-package ibuffer
    :ensure nil
    :bind ([remap list-buffers] . ibuffer))
#+END_SRC

** Uniquify

#+BEGIN_SRC emacs-lisp
  (use-package uniquify
    :ensure nil
    :config
    (setq uniquify-buffer-name-style 'forward))
#+END_SRC

** Server

#+BEGIN_SRC emacs-lisp
  (use-package server
    :ensure nil
    :if window-system
    :hook (after-init . server-start))
#+END_SRC

** Whitespace

#+BEGIN_SRC emacs-lisp
  (use-package whitespace
    :ensure nil
    :hook (after-init . global-whitespace-mode)
    :config
    (setq whitespace-style
          '(face tabs tab-mark trailing empty)
          whitespace-display-mappings
          '((tab-mark ?\t [?› ?\t])
            (space-mark ?\  [?·] [?.]))))
#+END_SRC

* Additional Packages

** Alert

#+BEGIN_SRC emacs-lisp
  (use-package alert
    :commands alert
    :init
    (setq alert-default-style 'notifier))
#+END_SRC

** Avy

#+BEGIN_SRC emacs-lisp
  (use-package avy
    :bind (("C-:" . avy-goto-char)
           ("C-'" . avy-goto-char-2)))
#+END_SRC

** Company

#+BEGIN_SRC emacs-lisp
  (use-package company
    :hook (after-init . global-company-mode)
    :bind (("TAB" . company-indent-or-complete-common)
           :map company-active-map
           ("C-n" . company-select-next)
           ("C-p" . company-select-previous))
    :config
    (setq company-idle-delay nil
          company-dabbrev-downcase nil))
#+END_SRC

** Evil

#+BEGIN_SRC emacs-lisp
  (use-package evil
    :hook (after-init . evil-mode)
    :init
    (setq evil-want-keybinding nil
          evil-disable-insert-state-bindings t))

  (use-package evil-collection
    :after evil
    :config (evil-collection-init))

  (use-package evil-surround
    :after evil
    :config (global-evil-surround-mode +1))

  (use-package evil-magit
    :after (evil magit))
#+END_SRC

** Flycheck

#+BEGIN_SRC emacs-lisp
  (use-package flycheck
    :config
    (setq flycheck-check-syntax-automatically '(save mode-enabled))

    ;; Define fringe indicator / warning levels
      (define-fringe-bitmap 'flycheck-fringe-bitmap-ball
        (vector #b00000000
                #b00000000
                #b00000000
                #b00000000
                #b00000000
                #b00000000
                #b00000000
                #b00011100
                #b00111110
                #b00111110
                #b00111110
                #b00011100
                #b00000000
                #b00000000
                #b00000000
                #b00000000
                #b00000000))
      (flycheck-define-error-level 'error
        :severity 2
        :overlay-category 'flycheck-error-overlay
        :fringe-bitmap 'flycheck-fringe-bitmap-ball
        :fringe-face 'flycheck-fringe-error)
      (flycheck-define-error-level 'warning
        :severity 1
        :overlay-category 'flycheck-warning-overlay
        :fringe-bitmap 'flycheck-fringe-bitmap-ball
        :fringe-face 'flycheck-fringe-warning)
      (flycheck-define-error-level 'info
        :severity 0
        :overlay-category 'flycheck-info-overlay
        :fringe-bitmap 'flycheck-fringe-bitmap-ball
        :fringe-face 'flycheck-fringe-info)

    ;; use local eslint from node_modules before global
    ;; http://emacs.stackexchange.com/questions/21205/flycheck-with-file-relative-eslint-executable
    (defun my/use-eslint-from-node-modules ()
      (let* ((root (locate-dominating-file
                    (or (buffer-file-name) default-directory)
                    "node_modules"))
             (eslint (and root
                          (expand-file-name "node_modules/eslint/bin/eslint.js"
                                            root))))
        (when (and eslint (file-executable-p eslint))
          (setq-local flycheck-javascript-eslint-executable eslint))))
    (add-hook 'flycheck-mode-hook #'my/use-eslint-from-node-modules))
#+END_SRC

** Git Modes

#+BEGIN_SRC emacs-lisp
  (use-package gitattributes-mode)
  (use-package gitconfig-mode)
  (use-package gitignore-mode)
#+END_SRC

** Hydra

#+BEGIN_SRC emacs-lisp
  (use-package hydra
    :config
    (defhydra hydra-bookmark(:color blue :columns 8)
      ("l" bookmark-bmenu-list "list")
      ("q" nil "Quit"))

    (defhydra hydra-counsel(:color blue :columns 8)
      ("g" counsel-git "counsel-git")
      ("i" counsel-semantic-or-imenu "counsel-menu")
      ("j" counsel-grep "counsel-grep")
      ("q" nil "Quit"))

    (defhydra hydra-magit(:color blue :columns 8)
      ("s" magit-status "magit status"))

    (defhydra hydra-space(:color teal :columns 8)
      ("b" hydra-bookmark/body "Bookmark")
      ("c" hydra-counsel/body "Counsel")
      ("g" hydra-magit/body "Magit")
      ("q" nil "Quit")))
#+END_SRC

** Ivy

#+BEGIN_SRC emacs-lisp
  (use-package ivy
    :hook (after-init . ivy-mode)
    :config (setq ivy-use-selectable-prompt t))

  (use-package counsel
    :bind (("M-x" . counsel-M-x)
           ("M-y" . counsel-yank-pop)
           ("C-c g" . counsel-git))
    :config
    (setq counsel-git-cmd
          "fd . --color never"
          counsel-rg-base-command
          "rg -i -M 120 --no-heading --line-number --color never %s ."
          counsel-grep-base-command
          "rg -i -M 120 --no-heading --line-number --color never '%s' %s"))

  (use-package swiper
    :bind ("C-s" . swiper-isearch))
#+END_SRC

** Magit

#+BEGIN_SRC emacs-lisp
  (use-package magit
    :bind ("C-x g" . magit-status))
#+END_SRC

** No Littering

#+BEGIN_SRC emacs-lisp
  (use-package no-littering)
#+END_SRC

** Rainbow Delimiters

#+BEGIN_SRC emacs-lisp
  (use-package rainbow-delimiters
    :hook ((prog-mode text-mode) . rainbow-delimiters-mode))
#+END_SRC

** Smartparens

#+BEGIN_SRC emacs-lisp
  (use-package smartparens
    :hook ((after-init . smartparens-global-mode)
           (after-init . show-smartparens-global-mode))
    :config
    (require 'smartparens-config))
#+END_SRC

** Themes

#+BEGIN_SRC emacs-lisp
  (use-package kaolin-themes
    :config
    (setq kaolin-themes-modeline-border nil)

    (load-theme 'kaolin-galaxy t))
#+END_SRC

** Undo Tree

#+BEGIN_SRC emacs-lisp
  (use-package undo-tree
    :hook (after-init . global-undo-tree-mode))
#+END_SRC

* Org Mode

** Appearance

#+BEGIN_SRC emacs-lisp
  (use-package org
    :defer t
    :ensure nil
    :custom-face
    (org-document-title ((t (:height 1))))
    (org-level-1 ((t (:height 1))))
    (org-level-2 ((t (:height 1))))
    (org-level-3 ((t (:height 1))))
    (org-level-4 ((t (:height 1))))
    (org-level-5 ((t (:height 1))))
    (org-level-6 ((t (:height 1)))))
#+END_SRC

* Programming

** Emacs-Lisp

#+BEGIN_SRC emacs-lisp
  ;; (use-package elisp-mode
  ;;   :ensure nil
  ;;   :config
  ;;   (with-eval-after-load "smartparens-config"
  ;;     (sp-local-pair 'emacs-lisp-mode "'" nil :actions nil)))
#+END_SRC

** Groovy

#+BEGIN_SRC emacs-lisp
  (use-package groovy-mode
    :mode "\\.groovy\\'")
#+END_SRC

** Javascript

#+BEGIN_SRC emacs-lisp
  (use-package js2-mode
    :interpreter ("node" . js2-mode)
    :mode (("\\.js\\'" . js2-mode)
           ("\\.jsx\\'" . js2-jsx-mode))
    :config
    (setq js2-basic-offset 2
          js2-mode-show-parse-errors nil
          js2-mode-show-strict-warnings nil))
#+END_SRC

** Lua

#+BEGIN_SRC emacs-lisp
  (use-package lua-mode
    :interpreter "lua"
    :mode "\\.lua\\'")
#+END_SRC

** Ruby

#+BEGIN_SRC emacs-lisp
  (use-package ruby-mode
    :interpreter "ruby"
    :config
    (require 'smartparens-ruby nil t)

    (setq flycheck-command-wrapper-function
          (lambda (command)
            (append '("bundle" "exec") command)))

    (setq ruby-insert-encoding-magic-comment nil))
#+END_SRC

** Web

#+BEGIN_SRC emacs-lisp
  (use-package emmet-mode
    :hook (web-mode css-mode))

  (use-package web-mode
    :mode ("\\.html\\'" "\\.erb\\'" "\\.json\\'" "\\.vue\\'")
    :config

    ;; Display
    (setq web-mode-enable-current-column-highlight t
          web-mode-enable-current-element-highlight t
          web-mode-enable-auto-indentation nil)

    ;; Format
    (setq web-mode-markup-indent-offset 2
          web-mode-css-indent-offset 2
          web-mode-code-indent-offset 2
          web-mode-style-padding 2
          web-mode-script-padding 2)

    (setq web-mode-content-types-alist
          '(("vue" . "\\.vue\\'")))

    (defun my/web-vue-setup()
      (flycheck-mode +1)
      (with-eval-after-load 'flycheck
        (flycheck-add-mode 'javascript-eslint 'web-mode))

      (setq web-mode-style-padding 0
            web-mode-script-padding 0))

    (add-hook 'web-mode-hook
              (lambda ()
                (turn-off-smartparens-mode)

                (cond ((equal web-mode-content-type "vue")
                       (my/web-vue-setup))))))

  (use-package css-mode
    :mode "\\.css\\'"
    :config (setq css-indent-offset 2))
#+END_SRC

** YAML

#+BEGIN_SRC emacs-lisp
  (use-package yaml-mode
    :mode "\\.yml\\'")
#+END_SRC
