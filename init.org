#+TITLE: Emacs 配置文件
#+STARTUP: indent
#+PROPERTY: header-args :tangle yes :results value silent

* Base Configuration

** personal information

#+BEGIN_SRC emacs-lisp
  (setq user-full-name "Wangzongcan"
        user-mail-address "wang.zongcan@gmail.com")
#+END_SRC

** Starting up

#+BEGIN_SRC emacs-lisp
  (setq gc-cons-threshold most-positive-fixnum)
  (add-hook 'after-init-hook (lambda () (setq gc-cons-threshold 800000)))
#+END_SRC

** Startup Screen

#+BEGIN_SRC emacs-lisp
  (setq inhibit-startup-screen t)
#+END_SRC

** PATH

#+BEGIN_SRC emacs-lisp
  (setenv "PATH" (concat "/usr/local/bin:" (getenv "PATH")))
#+END_SRC

** Encoding

使用 utf-8

#+BEGIN_SRC emacs-lisp
  (prefer-coding-system 'utf-8)
#+END_SRC

** Package Manager

#+BEGIN_SRC emacs-lisp
    (require 'package)

    (setq package-enable-at-startup nil
          package-archives '(("melpa" . "https://melpa.org/packages/")
                             ("org" . "http://orgmode.org/elpa/")))

    (package-initialize)
#+END_SRC

** GUI

设置 frame

#+BEGIN_SRC emacs-lisp
  (let ((settings '((internal-border-width . 0)
                    (menu-bar-lines . 0)
                    (tool-bar-lines . 0)
                    (vertical-scroll-bars . nil)
                    (font . "M+ 1m-12"))))
    (setq initial-frame-alist settings
          default-frame-alist settings))
#+END_SRC

最大化时，删除 frame 周围的空隙

#+BEGIN_SRC emacs-lisp
  (setq frame-resize-pixelwise t)
#+END_SRC

** Alarm Bell

关闭警报声

#+BEGIN_SRC emacs-lisp
  (setq ring-bell-function 'ignore)
#+END_SRC

** Auto Revert

#+BEGIN_SRC emacs-lisp
  (require 'autorevert)
  (global-auto-revert-mode +1)

  (setq auto-revert-interval .1
        auto-revert-verbose nil
        global-auto-revert-non-file-buffers t)
#+END_SRC

** Backup

关闭 auto-save 和 backup

#+BEGIN_SRC emacs-lisp
  (setq backup-inhibited t
        auto-save-default nil
        auto-save-list-file-name nil
        auto-save-list-file-prefix nil)
#+END_SRC

** Cursor

关闭光标闪烁

#+BEGIN_SRC emacs-lisp
  (blink-cursor-mode -1)
#+END_SRC

** Custom File

#+BEGIN_SRC emacs-lisp
  (setq custom-file (make-temp-file ""))
#+END_SRC

** Dired

文件管理

#+BEGIN_SRC emacs-lisp
  (eval-after-load 'dired
    '(progn
       (require 'ls-lisp)

       (setq dired-dwim-target t
             ls-lisp-dirs-first t
             dired-auto-revert-buffer t
             dired-recursive-copies 'always
             ls-lisp-use-insert-directory-program nil
             dired-hide-details-hide-symlink-targets nil)))
#+END_SRC

** Echo Area

#+BEGIN_SRC emacs-lisp
  (setq echo-keystrokes .1)
#+END_SRC

** Final Newline

#+BEGIN_SRC emacs-lisp
  (setq require-final-newline t)
#+END_SRC

** Highlight Line

高亮当前行

#+BEGIN_SRC emacs-lisp
  (global-hl-line-mode +1)
#+END_SRC

** Minibuffer

[[http://bling.github.io/blog/2016/01/18/why-are-you-changing-gc-cons-threshold/][为什么这么做]]

#+BEGIN_SRC emacs-lisp
  (add-hook 'minibuffer-setup-hook
            (lambda ()
              (setq gc-cons-threshold most-positive-fixnum)))

  (add-hook 'minibuffer-exit-hook
            (lambda ()
              (setq gc-cons-threshold 800000)))
#+END_SRC

** Tabs

不使用 tab

#+BEGIN_SRC emacs-lisp
  (setq-default indent-tabs-mode nil)
#+END_SRC

** Truncate Lines

#+BEGIN_SRC emacs-lisp
  (set-default 'truncate-lines t)
#+END_SRC

** Smooth Scrolling

#+BEGIN_SRC emacs-lisp
  (setq scroll-margin 1
        scroll-conservatively 10000
        scroll-preserve-screen-position t)
#+END_SRC

** Whitespace

#+BEGIN_SRC emacs-lisp
  (setq whitespace-style '(face empty tabs trailing))
  (add-hook 'before-save-hook #'whitespace-cleanup)
#+END_SRC

** Yes Or No P

#+BEGIN_SRC emacs-lisp
  (defalias 'yes-or-no-p 'y-or-n-p)
#+END_SRC

* External Packages

** Package Configuration

*** use-package

使用 use-package 安装和管理 package

#+BEGIN_SRC emacs-lisp
  (unless (package-installed-p 'use-package)
    (package-refresh-contents)
    (package-install 'use-package))

  (eval-when-compile
    (require 'use-package))
#+END_SRC

*** esup

#+BEGIN_SRC emacs-lisp
  (use-package esup :ensure t)
#+END_SRC

** Interface Enhancement

*** Ivy

#+BEGIN_SRC emacs-lisp
  (use-package ivy
    :ensure t
    :config
    (ivy-mode +1))
#+END_SRC

*** Counsel

#+BEGIN_SRC emacs-lisp
  (use-package counsel
    :ensure t
    :bind* ("M-x" . counsel-M-x))
#+END_SRC

*** Swiper

#+BEGIN_SRC emacs-lisp
  (use-package swiper
    :ensure t
    :bind* ("C-s" . swiper))
#+END_SRC

** File Manager

*** Dired+

#+BEGIN_SRC emacs-lisp
  (use-package dired+ :ensure t)
#+END_SRC

** Project management

*** projectile

#+BEGIN_SRC emacs-lisp
  (use-package projectile
    :ensure t
    :init (setq projectile-completion-system 'ivy)
    :config (projectile-mode))
#+END_SRC

*** projectile-rails

#+BEGIN_SRC emacs-lisp
  (use-package projectile-rails
    :ensure t
    :config (projectile-rails-global-mode +1))
#+END_SRC

** Theme

*** challenger-deep

#+BEGIN_SRC emacs-lisp
  (use-package challenger-deep-theme :defer t :ensure t)
#+END_SRC

*** color-theme-sanityinc-tomorrow

#+BEGIN_SRC emacs-lisp
  (use-package color-theme-sanityinc-tomorrow :defer t :ensure t)
#+END_SRC

*** darktooth-theme

#+BEGIN_SRC emacs-lisp
  (use-package darktooth-theme :defer t :ensure t)
#+END_SRC

*** dracula-theme

#+BEGIN_SRC emacs-lisp
  (use-package dracula-theme :defer t :ensure t)
#+END_SRC

*** monokai

#+BEGIN_SRC emacs-lisp
  (use-package monokai-theme :defer t :ensure t)
#+END_SRC

*** load-theme

#+BEGIN_SRC emacs-lisp
  (load-theme 'challenger-deep t)
#+END_SRC

** Visual

*** Rainbow Delimiters

#+BEGIN_SRC emacs-lisp
  (use-package rainbow-delimiters :ensure t)
#+END_SRC

*** Undo Tree

#+BEGIN_SRC emacs-lisp
  (use-package undo-tree :ensure t)
#+END_SRC

** Version control

*** Magit

#+BEGIN_SRC emacs-lisp
  (use-package magit :defer t :ensure t)
#+END_SRC

* Programming

** Prog mode

#+BEGIN_SRC emacs-lisp
  (add-hook 'prog-mode-hook
            '(lambda()
               (rainbow-delimiters-mode +1)
               (smartparens-mode +1)
               (whitespace-mode +1)))
#+END_SRC

** Company

#+BEGIN_SRC emacs-lisp
  (use-package company
    :ensure t
    :config
    (global-company-mode)
    (setq company-idle-delay 0.1
          company-minimum-prefix-length 1
          company-begin-commands '(self-insert-command))

    (bind-keys
     :map global-map
     ("C-i" . company-indent-or-complete-common)
     :map company-active-map
     ("C-n" . company-select-next)
     ("C-p" . company-select-previous)))
#+END_SRC

** Flycheck

#+BEGIN_SRC emacs-lisp
  (use-package flycheck :defer t :ensure t)
#+END_SRC

** SmartParens

#+BEGIN_SRC emacs-lisp
  (use-package smartparens-config
    :ensure smartparens
    :config (show-smartparens-global-mode))
#+END_SRC

* Programming Language

** Ruby

*** chruby

#+BEGIN_SRC emacs-lisp
  (use-package chruby
    :ensure t)
#+END_SRC

*** ruby-mode

#+BEGIN_SRC emacs-lisp
  (use-package ruby-mode
    :config
    (require 'smartparens-ruby)

    (setq ruby-insert-encoding-magic-comment nil)

    (add-hook 'ruby-mode-hook
              (lambda ()
                (flycheck-mode +1))))
#+END_SRC

*** inf-ruby

#+BEGIN_SRC emacs-lisp
  (use-package inf-ruby :ensure t)
#+END_SRC

** Web Development

*** web-mode

#+BEGIN_SRC emacs-lisp
  (use-package web-mode
    :ensure t
    :mode (("\\.html\\'" . web-mode)
           ("\\.erb\\'" . web-mode))
    :config
    (setq web-mode-style-padding 2
          web-mode-script-padding 2
          web-mode-css-indent-offset 2
          web-mode-attr-indent-offset 2
          web-mode-code-indent-offset 2
          web-mode-markup-indent-offset 2
          web-mode-enable-current-element-highlight t
          web-mode-enable-current-column-highlight t)

    (add-hook 'web-mode-hook
              '(lambda ()
                 (smartparens-mode -1))))
#+END_SRC

*** emmet

#+BEGIN_SRC emacs-lisp
  (use-package emmet-mode
    :ensure t
    :config
    (add-hook 'web-mode-hook 'emmet-mode)
    (add-hook 'sgml-mode-hook 'emmet-mode)
    (add-hook 'css-mode-hook 'emmet-mode))
#+END_SRC

** Javascript

*** nvm

#+BEGIN_SRC emacs-lisp
  (use-package nvm
    :ensure t
    :config (nvm-use (caar (last (nvm--installed-versions)))))
#+END_SRC

*** js2-mode

#+BEGIN_SRC emacs-lisp
  (use-package js2-mode
    :ensure t
    :mode (("\\.js\\'" . js2-mode)
           ("\\.es6\\'" . js2-mode)
           ("\\.jsx\\'" . js2-jsx-mode))
    :interpreter (("node" . js2-mode))
    :config
    (setq-default js2-indent-level 2)

    (setq js-indent-level 2
          js2-basic-offset 2
          js2-mode-show-parse-errors nil
          js2-mode-show-strict-warnings nil))
#+END_SRC

*** coffee-mode

#+BEGIN_SRC emacs-lisp
  (use-package coffee-mode :ensure t :mode "\\.coffee\\'")
#+END_SRC

** Java

#+BEGIN_SRC emacs-lisp
  (use-package meghanada
    :ensure t
    :config
    (add-hook 'java-mode-hook #'meghanada-mode))
#+END_SRC

** CSS

*** css-mode

#+BEGIN_SRC emacs-lisp
  (use-package css-mode
    :defer t
    :config (setq css-indent-offset 2))
#+END_SRC

*** sass-mode

#+BEGIN_SRC emacs-lisp
  (use-package sass-mode
    :ensure t
    :mode ("\\.sass\\'" . sass-mode))
#+END_SRC

*** scss-mode

#+BEGIN_SRC emacs-lisp
  (use-package scss-mode
    :ensure t
    :mode ("\\.scss\\'" . scss-mode)
    :config (setq scss-compile-at-save nil))
#+END_SRC

** YAML

#+BEGIN_SRC emacs-lisp
  (use-package yaml-mode
    :ensure t
    :mode ("\\.yml\\'" . yaml-mode))
#+END_SRC

** Groovy

#+BEGIN_SRC emacs-lisp
  (use-package groovy-mode :ensure t :defer t)
#+END_SRC

* Integration

** Search

*** ag

#+BEGIN_SRC emacs-lisp
  (use-package ag :defer t :ensure t)
#+END_SRC

** google-translate

#+BEGIN_SRC emacs-lisp
  (use-package google-translate-smooth-ui
    :ensure google-translate
    :bind* ("\C-ct" . google-translate-smooth-translate)
    :config (setq google-translate-translation-directions-alist '(("en" . "zh-CN"))))
#+END_SRC

* Vim Emulation

** Evil

#+BEGIN_SRC emacs-lisp
  (use-package evil
    :ensure t
    :config
    (evil-mode +1)

    (setcdr evil-insert-state-map nil)
    (bind-keys
     :map evil-insert-state-map
     ([escape] . evil-normal-state)
     ((read-kbd-macro evil-toggle-key) . evil-emacs-state)))
#+END_SRC

** Evil Surround

#+BEGIN_SRC emacs-lisp
  (use-package evil-surround
    :ensure t
    :config
    (global-evil-surround-mode +1))
#+END_SRC

* Note
** Org-mode

#+BEGIN_SRC emacs-lisp
  (use-package org
    :defer t
    :ensure org-plus-contrib
    :pin org
    :config
    (setq org-startup-indented t
          org-src-fontify-natively t))
#+END_SRC

** Org-publish

#+BEGIN_SRC emacs-lisp
  (use-package ox-publish
    :defer t
    :commands (org-publish-project publish-blog)
    :config

    (defun publish-blog()
      "publish my blog"
      (interactive)
      (org-publish-project "blog"))

    (defun read-html-template (template-file)
      (with-temp-buffer
        (insert-file-contents template-file)
        (buffer-string)))

    (setq
     org-publish-use-timestamps-flag nil

     org-export-with-section-numbers nil  ;; 去掉编号
     org-export-with-toc nil              ;; 关闭 TOC

     org-html-divs '((preamble "header" "top")
                     (content "main" "content")
                     (postamble "footer" "postamble"))

     org-html-postamble nil
     org-html-html5-fancy t
     org-html-doctype "html5"
     org-html-container-element "section"
     org-html-head-include-scripts nil        ;; 去掉默认的 script
     org-html-head-include-default-style nil  ;; 去掉默认的 css
     org-html-metadata-timestamp-format "%Y-%m-%d")

    (setq blog-html-head (read-html-template "~/Dropbox/Blog/include/head.html"))
    (setq blog-html-preamble (read-html-template "~/Dropbox/Blog/include/nav.html"))

    (setq org-publish-project-alist
          `(("blog" :components ("blog-notes" "blog-pages" "blog-assets"))

            ("blog-notes"
             :base-extension "org"
             :base-directory "~/Dropbox/Blog/notes"
             :publishing-directory "~/Blog/"
             :publishing-function org-html-publish-to-html

             :html-head ,blog-html-head
             :html-preamble ,blog-html-preamble

             :auto-sitemap t
             :sitemap-title "Blog"
             :sitemap-filename "index.org"
             :sitemap-file-entry-format "%d » [%t]"
             :sitemap-function org-publish-org-sitemap)

            ("blog-pages"
             :base-extension "org"
             :base-directory "~/Dropbox/Blog/pages"
             :publishing-directory "~/Blog/"
             :publishing-function org-html-publish-to-html

             :html-head ,blog-html-head
             :html-preamble ,blog-html-preamble)

            ("blog-assets"
             :base-extension "css\\|js"
             :base-directory "~/Dropbox/Blog/"
             :publishing-directory "~/Blog/"
             :publishing-function org-publish-attachment

             :recursive t))))
#+END_SRC

** Deft

#+BEGIN_SRC emacs-lisp
  (use-package deft
    :defer t
    :ensure t
    :commands deft
    :config
    (setq deft-recursive t
          deft-extensions '("org")
          deft-directory "~/Dropbox/Notes"))
#+END_SRC
