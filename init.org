#+TITLE: Emacs 26 Configuration
#+STARTUP: align indent
#+PROPERTY: header-args :tangle yes :results value silent

* Speed Up Startup

#+BEGIN_SRC emacs-lisp
  (setq gc-cons-threshold 402653184
        gc-cons-percentage 0.6)

  (add-hook 'emacs-startup-hook
            (lambda ()
              (setq gc-cons-threshold 16777216
                    gc-cons-percentage 0.1)))
#+END_SRC

* Package Management

#+BEGIN_SRC emacs-lisp
  (setq package-enable-at-startup nil
        package--init-file-ensured t)

  (require 'package)
  (package-initialize)

  (add-to-list 'package-archives
               '("melpa" . "https://melpa.org/packages/") t)

  (when (not (package-installed-p 'use-package))
    (package-refresh-contents)
    (package-install 'use-package))

  (eval-when-compile
    (require 'use-package)
    (setq use-package-verbose t
          use-package-always-ensure t))

  (use-package bind-key)
#+END_SRC

* Environment Settings

** PATH

#+BEGIN_SRC emacs-lisp
  (setenv "PATH" (concat (getenv "PATH") ":/usr/local/bin"))
  (setq-default exec-path (append exec-path '("/usr/local/bin")))
#+END_SRC

* Frame Settings
** Initial

#+BEGIN_SRC emacs-lisp

  (let ((settings '((font . "等距更纱黑体 SC-12")
                    (horizontal-scroll-bars . nil)
                    (internal-border-width . 0)
                    (menu-bar-lines . 0)
                    (ns-transparent-titlebar . t)
                    (ns-appearance . dark)
                    (tool-bar-lines . 0)
                    (vertical-scroll-bars . nil))))
    (setq default-frame-alist settings
          initial-frame-alist settings))
#+END_SRC

** Resize Pixelwise

#+BEGIN_SRC emacs-lisp
  (setq frame-resize-pixelwise t)
#+END_SRC

** Dialog

#+BEGIN_SRC emacs-lisp
  (setq use-dialog-box nil)
#+END_SRC

** Tooltip

#+BEGIN_SRC emacs-lisp
  (tooltip-mode -1)
#+END_SRC

** Theme

#+BEGIN_SRC emacs-lisp
  (use-package base16-theme
    :config
    (setq base16-distinct-fringe-background nil
          base16-highlight-mode-line 'contrast)
    (load-theme 'base16-snazzy t))
#+END_SRC

* Window Settings
** Scroll

#+BEGIN_SRC emacs-lisp
  (setq hscroll-margin 1
        hscroll-step 1
        scroll-margin 1
        scroll-conservatively 10000
        scroll-preserve-screen-position t)
#+END_SRC

** Mode Line

#+BEGIN_SRC emacs-lisp
  (column-number-mode 1)

  (use-package minions
    :config (minions-mode))
#+END_SRC

* Minibuffer Settings
** Echo

#+BEGIN_SRC emacs-lisp
  (setq echo-keystrokes 0.1)
#+END_SRC

** Completion

#+BEGIN_SRC emacs-lisp
  (use-package ivy
    :hook (after-init . ivy-mode)
    :config (setq ivy-use-selectable-prompt t))

  (use-package counsel
    :bind (("M-x" . counsel-M-x)
           ("M-y" . counsel-yank-pop)))
#+END_SRC

** Enable Recursive

#+BEGIN_SRC emacs-lisp
  (setq enable-recursive-minibuffers t)
#+END_SRC

** Hook

#+BEGIN_SRC emacs-lisp
  (defun my-minibuffer-setup-hook()
    (electric-pair-local-mode -1)
    (setq gc-cons-threshold most-positive-fixnum))

  (defun my-minibuffer-exit-hook()
    (setq gc-cons-threshold 16777216))

  (add-hook 'minibuffer-setup-hook #'my-minibuffer-setup-hook)
  (add-hook 'minibuffer-exit-hook #'my-minibuffer-exit-hook)
#+END_SRC

* Display Settings
** Startup Screen

#+BEGIN_SRC emacs-lisp
  (setq inhibit-startup-screen t
        initial-scratch-message "")
#+END_SRC

** Cursor

#+BEGIN_SRC emacs-lisp
  (blink-cursor-mode -1)
#+END_SRC

** Truncate Line

#+BEGIN_SRC emacs-lisp
  (setq-default truncate-lines t)
#+END_SRC

** Ring Bell

#+BEGIN_SRC emacs-lisp
  (setq ring-bell-function #'ignore)
#+END_SRC

** Whitespace

#+BEGIN_SRC emacs-lisp
  (setq-default show-trailing-whitespace t)
#+END_SRC

** Paren

#+BEGIN_SRC emacs-lisp
  (use-package paren
    :hook (after-init . show-paren-mode)
    :config
    (setq blink-matching-paren nil
          show-paren-when-point-inside-paren t))

  (use-package rainbow-delimiters
    :hook ((prog-mode text-mode) . rainbow-delimiters-mode))
#+END_SRC

** Final Newline

#+BEGIN_SRC emacs-lisp
  (setq require-final-newline t)
#+END_SRC

* File Settings
** Auto Revert

#+BEGIN_SRC emacs-lisp
  (use-package autorevert
    :hook (after-init . global-auto-revert-mode)
    :config
    (setq auto-revert-interval 0.1
          auto-revert-verbose nil
          global-auto-revert-non-file-buffers t))
#+END_SRC

** Auto Save

#+BEGIN_SRC emacs-lisp
  (setq auto-save-default          nil
        auto-save-list-file-name   nil
        auto-save-list-file-prefix nil)
#+END_SRC

** Backup

#+BEGIN_SRC emacs-lisp
  (setq backup-inhibited t)
#+END_SRC

** Dired

#+BEGIN_SRC emacs-lisp
  (use-package dired :ensure nil :defer t
    :hook ((dired-mode . diredfl-mode)
           (dired-mode . dired-omit-mode)
           (dired-mode . dired-hide-details-mode))
    :bind (("C-x C-j" . dired-jump)
           :map dired-mode-map
           ("I" . dired-kill-subdir))
    :config
    (setq dired-dwim-target t
          dired-recursive-copies 'always
          insert-directory-program "gls"
          dired-listing-switches "-aBhl --group-directories-first")

    (use-package dired-x :ensure nil
      :config
      (setq dired-omit-files
            (concat dired-omit-files "\\|^.DS_Store$"))))
#+END_SRC

** Lockfile

#+BEGIN_SRC emacs-lisp
  (setq create-lockfiles nil)
#+END_SRC

** No Littering

#+BEGIN_SRC emacs-lisp
  (use-package no-littering)
#+END_SRC

* Edit Settings
** Undo

#+BEGIN_SRC emacs-lisp
  (use-package undo-tree
    :config (global-undo-tree-mode))
#+END_SRC

** Evil

#+BEGIN_SRC emacs-lisp
  (use-package evil
    :defer 0.3
    :init (setq evil-disable-insert-state-bindings t)
    :config (evil-mode))

  (use-package evil-escape
    :config
    (setq evil-escape-key-sequence "fj")
    (setq evil-escape-unordered-key-sequence t)
    (evil-escape-mode))
#+END_SRC

** Indent

#+BEGIN_SRC emacs-lisp
  (setq-default indent-tabs-mode nil)
#+END_SRC

** Completion

#+BEGIN_SRC emacs-lisp
  (use-package company
    :hook (after-init . global-company-mode)
    :bind (("TAB" . company-indent-or-complete-common)
           :map company-active-map
           ("C-n" . company-select-next)
           ("C-p" . company-select-previous))
    :config (setq company-idle-delay nil))
#+END_SRC

** Confrimation

#+BEGIN_SRC emacs-lisp
  (fset 'yes-or-no-p 'y-or-n-p)
#+END_SRC

** Search

#+BEGIN_SRC emacs-lisp
  (use-package swiper
    :bind ("C-s" . swiper))

  (use-package anzu
    :bind (([remap query-replace] . anzu-query-replace)
           ([remap query-replace-regexp]. anzu-query-replace-regexp))
    :config
    (global-anzu-mode 1)

    (setq anzu-mode-lighter ""
          anzu-deactivate-region t
          anzu-search-threshold 1000
          anzu-replace-threshold 50
          anzu-replace-to-string-separator " => "))
#+END_SRC

** Server

#+BEGIN_SRC emacs-lisp
  (use-package server
    :if window-system
    :hook (after-init . server-start))
#+END_SRC

** Electric Pair

#+BEGIN_SRC emacs-lisp
  (electric-pair-mode 1)
#+END_SRC

* Version Control
** Magit

#+BEGIN_SRC emacs-lisp
  (use-package magit
    :bind ("C-x g" . magit-status)
    :config
    (setq magit-display-buffer-function #'magit-display-buffer-fullframe-status-v1))
#+END_SRC

* Project Management
** Projectile

#+BEGIN_SRC emacs-lisp
  (use-package projectile
    :hook (after-init . projectile-mode)
    :bind (:map projectile-mode-map
           ("C-c p" . projectile-command-map))
    :config
    (setq projectile-mode-line nil
          projectile-indexing-method 'alien
          projectile-git-submodule-command ""
          projectile-completion-system 'ivy))
#+END_SRC

* Programming Languages
** Ruby

#+BEGIN_SRC emacs-lisp
  (use-package ruby-mode
    :interpreter "ruby"
    :config
    (defun my-ruby-mode-hook()
      (setq ruby-insert-encoding-magic-comment nil))

    (add-hook 'ruby-mode-hook #'my-ruby-mode-hook))
#+END_SRC

** Javascript

#+BEGIN_SRC emacs-lisp
  (use-package js2-mode
    :defer t
    :interpreter ("node" . js2-mode)
    :mode (("\\.js\\'" . js2-mode)
           ("\\.jsx\\'" . js2-jsx-mode))
    :config
    (defun my-js2-mode-hook()
      (setq js2-basic-offset 2
            js2-mode-show-parse-errors nil
            js2-mode-show-strict-warnings nil))

    (add-hook 'js2-mode-hook #'my-js2-mode-hook))
#+END_SRC

** Web Mode

#+BEGIN_SRC emacs-lisp
  (use-package web-mode
    :defer t
    :mode (("\\.html\\'" . web-mode)
           ("\\.erb\\'" . web-mode)
           ("\\.json\\'" . web-mode)
           ("\\.vue\\'" . web-mode))
    :config
    (defun my-web-mode-hook()
      (use-package emmet-mode
        :config (emmet-mode))

      (setq web-mode-enable-auto-pairing t
            web-mode-enable-auto-indentation nil
            web-mode-markup-indent-offset 2
            web-mode-css-indent-offset 2
            web-mode-code-indent-offset 2
            web-mode-style-padding 2
            web-mode-script-padding 2))
    (add-hook 'web-mode-hook #'my-web-mode-hook))
#+END_SRC

** CSS

#+BEGIN_SRC emacs-lisp
  (use-package css-mode
    :mode ("\\.css\\'" . css-mode)
    :config (setq css-indent-offset 2))
#+END_SRC

** Lua

#+BEGIN_SRC emacs-lisp
  (use-package lua-mode
    :interpreter "lua"
    :mode ("\\.lua\\'" . lua-mode))
#+END_SRC

** YAML

#+BEGIN_SRC emacs-lisp
  (use-package yaml-mode
    :defer t
    :mode ("\\.yml\\'" . yaml-mode))
#+END_SRC

