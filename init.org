#+TITLE: Emacs 配置
#+STARTUP: align indent
#+PROPERTY: header-args :tangle yes :results value silent

* Initialization

** Load Newest

#+BEGIN_SRC emacs-lisp
  (setq-default load-prefer-newer t)
#+END_SRC

** Functions

*** Change GC Cons

#+BEGIN_SRC emacs-lisp
  (defun change-gc-cons()
    (setq gc-cons-threshold most-positive-fixnum
          gc-cons-percentage 0.6))
#+END_SRC

*** Reset GC Cons

#+BEGIN_SRC emacs-lisp
  (defun reset-gc-cons()
    (setq gc-cons-threshold (* 100 1024 1024)
          gc-cons-percentage 0.1))
#+END_SRC

** Optimizing GC

#+BEGIN_SRC emacs-lisp
  (change-gc-cons)
  (add-hook 'emacs-startup-hook #'reset-gc-cons)
#+END_SRC

** File Name Handler

#+BEGIN_SRC emacs-lisp
  (defvar doom--file-name-handler-alist file-name-handler-alist)
  (setq file-name-handler-alist nil)
  (add-hook 'emacs-startup-hook
            (lambda () (setq file-name-handler-alist doom--file-name-handler-alist)))
#+END_SRC

** PATH

#+BEGIN_SRC emacs-lisp
  (setenv "PATH" (concat (getenv "PATH") ":/usr/local/bin"))
  (setq-default exec-path (append exec-path '("/usr/local/bin")))
#+END_SRC

* Package Management

** Package.el

#+BEGIN_SRC emacs-lisp
  (require 'package)

  (setq-default
   package-enable-at-startup nil
   package--init-file-ensured t)

  (add-to-list 'package-archives '("melpa" . "https://melpa.org/packages/") t)
  (add-to-list 'package-archives '("org" . "https://orgmode.org/elpa/") t)

  (package-initialize)
#+END_SRC

** Use Package

#+BEGIN_SRC emacs-lisp
  (when (not (package-installed-p 'use-package))
    (package-refresh-contents)
    (package-install 'use-package))

  (eval-when-compile
    (require 'use-package)
    (setq-default
     use-package-always-defer t
     use-package-always-ensure t))
#+END_SRC

* Appearance

** Base

*** Alarms

#+BEGIN_SRC emacs-lisp
  (setq-default ring-bell-function 'ignore)
#+END_SRC

*** Echo Area

#+BEGIN_SRC emacs-lisp
  (setq-default echo-keystrokes 0.1)
#+END_SRC

*** Line Number

#+BEGIN_SRC emacs-lisp
  (use-package display-line-numbers
   :hook ((prog-mode conf-mode) . display-line-numbers-mode)
   :config (setq-default display-line-numbers-width 4))
#+END_SRC

*** Menu Bar

#+BEGIN_SRC emacs-lisp
  (menu-bar-mode -1)
#+END_SRC

*** Rainbow Delimiters

#+BEGIN_SRC emacs-lisp
  (use-package rainbow-delimiters
    :hook (prog-mode . rainbow-delimiters-mode))
#+END_SRC

*** Scroll

#+BEGIN_SRC emacs-lisp
  (setq-default
   scroll-margin                   1
   scroll-conservatively           10000
   scroll-preserve-screen-position t)
#+END_SRC

*** Startup Screen

#+BEGIN_SRC emacs-lisp
  (setq-default
   inhibit-startup-screen  t
   initial-scratch-message ""
   initial-major-mode      'text-mode)
#+END_SRC

*** Themes

#+BEGIN_SRC emacs-lisp
  (use-package dracula-theme)

  (load-theme 'dracula t)
#+END_SRC

*** Whitespace

#+BEGIN_SRC emacs-lisp
  (use-package whitespace
    :hook ((prog-mode text-mode) . whitespace-turn-on)
    :config (setq-default whitespace-style '(face empty tabs trailing)))
#+END_SRC

** Window System

#+BEGIN_SRC emacs-lisp
  (when window-system
    (tool-bar-mode -1)
    (scroll-bar-mode -1)
    (blink-cursor-mode -1)

    (let ((no-border '(internal-border-width . 0)))
      (add-to-list 'default-frame-alist no-border)
      (add-to-list 'initial-frame-alist no-border))

    (set-default-font "等距更纱黑体 SC-12" nil t)

    (setq-default
     truncate-lines t
     use-dialog-box nil))
#+END_SRC

** Mac

#+BEGIN_SRC emacs-lisp
  (when (eq system-type 'darwin)
    (add-to-list 'default-frame-alist '(ns-appearance . dark))
    (add-to-list 'default-frame-alist '(ns-transparent-titlebar . t))

    (setq-default frame-resize-pixelwise t))
#+END_SRC

* Editing

** Ace Window

#+BEGIN_SRC emacs-lisp
  (use-package ace-window
    :commands ace-window
    :bind ("C-x o" . ace-window)
    :config (setq aw-keys '(?a ?s ?d ?f ?g ?h ?j ?k ?l)))
#+END_SRC

** Auto Revert

#+BEGIN_SRC emacs-lisp
  (use-package autorevert
    :hook (dired-mode . auto-revert-mode)
    :init (add-hook 'after-init-hook #'global-auto-revert-mode)
    :config (setq-default auto-revert-interval 0.1))
#+END_SRC

** Editorconfig

#+BEGIN_SRC emacs-lisp
  (use-package editorconfig
    :init (editorconfig-mode))
#+END_SRC

** Flycheck

#+BEGIN_SRC emacs-lisp
  (use-package flycheck
    :hook (ruby-mode . flycheck-mode))
#+END_SRC

** Minibuffer

#+BEGIN_SRC emacs-lisp
  (add-hook 'minibuffer-setup-hook #'change-gc-cons)
  (add-hook 'minibuffer-exit-hook #'reset-gc-cons)
#+END_SRC

** Server

#+BEGIN_SRC emacs-lisp
  (use-package server
    :commands server-running-p
    :if (window-system)
    :init (unless (server-running-p (server-start))))
#+END_SRC

** Smartparens

#+BEGIN_SRC emacs-lisp
  (use-package smartparens-config :ensure smartparens
    :hook ((prog-mode web-mode) . smartparens-mode)
    :init (show-smartparens-global-mode))
#+END_SRC

** Uniquify

#+BEGIN_SRC emacs-lisp
  (setq-default uniquify-buffer-name-style 'forward)
#+END_SRC

** Y Or N

#+BEGIN_SRC emacs-lisp
  (defalias 'yes-or-no-p 'y-or-n-p)
#+END_SRC

* File & Directory

** Auto Save

#+BEGIN_SRC emacs-lisp
  (setq-default
   auto-save-default          nil
   auto-save-list-file-name   nil
   auto-save-list-file-prefix nil
   auto-save-list-file-prefix nil)
#+END_SRC

** Backup

#+BEGIN_SRC emacs-lisp
  (setq-default backup-inhibited t)
#+END_SRC

** Dired

#+BEGIN_SRC emacs-lisp
  (use-package dired-x :ensure nil
    :bind ("C-x C-j" . dired-jump))

  (use-package dired-aux :ensure nil
    :after dired-x
    :bind (:map dired-mode-map
           ("I" . dired-kill-subdir)))

  (use-package ls-lisp :defer 0 :ensure nil
    :config
    (setq-default
     ls-lisp-dirs-first                   t
     ls-lisp-use-insert-directory-program nil))

  (use-package dired :ensure nil
    :after ls-lisp
    :hook (dired-mode . dired-hide-details-mode)
    :config
    (setq-default
     dired-dwim-target      t
     dired-recursive-copies 'always))
#+END_SRC

** Lockfiles

#+BEGIN_SRC emacs-lisp
  (setq-default create-lockfiles nil)
#+END_SRC

* Org Mode

#+BEGIN_SRC emacs-lisp
  (use-package org
    :config
    (dolist (face '(org-level-1
                    org-level-2
                    org-level-3
                    org-level-4
                    org-level-5))
      (set-face-attribute face nil :height 1.0 :bold t)))
  (use-package org-plus-contrib)
#+END_SRC

* Vim Emulation

** Evil

#+BEGIN_SRC emacs-lisp
  (use-package evil
    :init
    (setq-default
     evil-disable-insert-state-bindings t)

    (evil-mode))
#+END_SRC

* Version Control

** Magit

#+BEGIN_SRC emacs-lisp
  (use-package magit :bind ("C-x g" . magit-status))
#+END_SRC

* Project Management

** Projectile

#+BEGIN_SRC emacs-lisp
  (use-package projectile
    :bind-keymap ("C-c p" . projectile-command-map)
    :init (setq projectile-completion-system 'ivy
                projectile-mode-line nil))
#+END_SRC

** Projectile Riggrep

#+BEGIN_SRC emacs-lisp
  (use-package ripgrep)
  (use-package projectile-ripgrep
    :commands projectile-ripgrep)
#+END_SRC

* Completion

** Swiper

#+BEGIN_SRC emacs-lisp
  (use-package swiper
    :bind ("C-s" . swiper))

  (use-package counsel
    :bind ("M-x" . counsel-M-x))

  (use-package ivy
    :init (ivy-mode)
    :config (setq ivy-use-selectable-prompt t))
#+END_SRC

** Company

#+BEGIN_SRC emacs-lisp
  (use-package company
    :bind (("TAB" . company-indent-or-complete-common)
           :map company-active-map
           ("C-n" . company-select-next)
           ("C-p" . company-select-previous))
    :init
    (setq-default company-idle-delay nil)

    (global-company-mode))
#+END_SRC

* Languages

*** CSS

**** SASS Mode

#+BEGIN_SRC emacs-lisp
  (use-package sass-mode
    :mode ("\\.sass\\'" . sass-mode))
#+END_SRC

**** SCSS Mode

#+BEGIN_SRC emacs-lisp
  (use-package scss-mode
    :mode ("\\.scss\\'" . scss-mode)
    :config (setq scss-compile-at-save nil))
#+END_SRC

*** Dockerfile

#+BEGIN_SRC emacs-lisp
  (use-package dockerfile-mode)
#+END_SRC

*** Elisp

#+BEGIN_SRC emacs-lisp
  (use-package elisp-mode :ensure nil
    :config (sp-local-pair 'emacs-lisp-mode "'" nil :actions nil))
#+END_SRC

*** Javascript

**** JS2 Mode

#+BEGIN_SRC emacs-lisp
  (use-package js2-mode
    :mode ("\\.js\\'" . js2-mode)
    :interpreter ("node" . js2-mode))
#+END_SRC

**** Rjsx Mode

#+BEGIN_SRC emacs-lisp
  (use-package rjsx-mode
    :mode ("\\.jsx\\'" . rjsx-mode))
#+END_SRC

**** Tern

#+BEGIN_SRC emacs-lisp
  (use-package tern
    :hook ((js2-mode rjsx-mode) . tern-mode)
    :init
    (use-package company-tern
      :init (add-to-list 'company-backends 'company-tern)))
#+END_SRC

*** Ruby
**** Chruby

#+BEGIN_SRC emacs-lisp
  (use-package chruby)
#+END_SRC

**** Inf Ruby

#+BEGIN_SRC emacs-lisp
  (use-package inf-ruby
    :hook (ruby-mode . inf-ruby-minor-mode))
#+END_SRC

**** Rspec Mode

#+BEGIN_SRC emacs-lisp
  (use-package rspec-mode)
#+END_SRC

**** Ruby Mode

#+BEGIN_SRC emacs-lisp
  (use-package ruby-mode
    :interpreter "ruby"
    :config
    (setq ruby-insert-encoding-magic-comment nil)

    (require 'smartparens-ruby)
    (chruby "2.4")
    (setq flycheck-checker 'ruby-rubocop))
#+END_SRC

**** Rubocop

#+BEGIN_SRC emacs-lisp
  (use-package rubocop
    :hook (ruby-mode . rubocop-mode))
#+END_SRC

**** Projectile Rails

#+BEGIN_SRC emacs-lisp
  (use-package projectile-rails
    :bind-keymap ("C-c r" . projectile-rails-command-map))
#+END_SRC

*** Web
**** Web Mode

#+BEGIN_SRC emacs-lisp
  (use-package web-mode
    :mode (("\\.html\\'" . web-mode)
           ("\\.erb\\'" . web-mode)
           ("\\.json\\'" . web-mode))
    :config
    (setq web-mode-enable-auto-pairing nil
          web-mode-enable-auto-indentation nil)

    ;; Smartparens
    (sp-with-modes 'web-mode
      (sp-local-pair "{ " " }")
      (sp-local-pair "<% " " %>")
      (sp-local-pair "<%= " " %>")))
#+END_SRC

**** Emmet

#+BEGIN_SRC emacs-lisp
  (use-package emmet-mode
    :hook ((web-mode sgml-mode css-mode) . emmet-mode))
#+END_SRC

*** YAML

#+BEGIN_SRC emacs-lisp
  (use-package yaml-mode
    :mode ("\\.yml\\'" . yaml-mode))
#+END_SRC
