#+TITLE: Emacs 配置文件
#+STARTUP: indent
#+PROPERTY: header-args :tangle yes :results value silent

* Optimizing Startup

加快启动速度

#+BEGIN_SRC emacs-lisp
  (setq gc-cons-threshold (* 100 1024 1024))
  (add-hook 'after-init-hook (lambda () (setq gc-cons-threshold 800000)))
#+END_SRC

* Personal Information

#+BEGIN_SRC emacs-lisp
  (setq user-full-name "Wangzongcan"
        user-mail-address "wang.zongcan@gmail.com")
#+END_SRC

* Package Configuration

** Package.el

#+BEGIN_SRC emacs-lisp
  (require 'package)

  (setq package-enable-at-startup nil
        package-archives '(("melpa" . "https://melpa.org/packages/")
                           ("org" . "http://orgmode.org/elpa/")
                           ("gnu" . "http://elpa.gnu.org/packages/")))

  (package-initialize)
#+END_SRC

** Use Package

使用 use-package 安装和管理 package

#+BEGIN_SRC emacs-lisp
  (unless (package-installed-p 'use-package)
    (package-refresh-contents)
    (package-install 'use-package))

  (eval-when-compile
    (require 'use-package))
  (require 'diminish)
  (require 'bind-key)
#+END_SRC

* Base Configuration

** Appearance

*** Cursor

#+BEGIN_SRC emacs-lisp
  (blink-cursor-mode -1)

  (add-hook 'minibuffer-setup-hook
            (lambda ()
              (setq-local cursor-type 'bar)))
#+END_SRC

*** Frame

#+BEGIN_SRC emacs-lisp
  (setq frame-resize-pixelwise t)

  (let ((settings '((font . "M+ 1m-12")
                    (horizontal-scroll-bars . nil)
                    (internal-border-width . 0)
                    (menu-bar-lines . 0)
                    (tool-bar-lines . 0)
                    (vertical-scroll-bars . nil))))
    (setq default-frame-alist settings
          initial-frame-alist settings))
#+END_SRC

*** Mode Line

在 mode line 上显示光标所在位置

#+BEGIN_SRC emacs-lisp
  (setq line-number-mode t
        column-number-mode t)
#+END_SRC

** Auto Revert

#+BEGIN_SRC emacs-lisp
  (use-package autorevert
    :config
    (global-auto-revert-mode +1)

    (setq auto-revert-interval .1
          auto-revert-verbose nil
          global-auto-revert-non-file-buffers t))
#+END_SRC

** Backup

关闭 auto-save, backup, lockfiles

#+BEGIN_SRC emacs-lisp
  (setq auto-save-default nil
        auto-save-list-file-name nil
        auto-save-list-file-prefix nil
        backup-inhibited t
        create-lockfiles nil)
#+END_SRC

** Custom File

#+BEGIN_SRC emacs-lisp
  (setq custom-file (make-temp-file ""))
#+END_SRC

** Dired

文件管理

#+BEGIN_SRC emacs-lisp
  (use-package dired-x)
  (use-package dired
    :defer t
    :config
    (use-package ls-lisp)

    (setq dired-dwim-target t
          ls-lisp-dirs-first t
          dired-auto-revert-buffer t
          dired-recursive-copies 'always
          ls-lisp-use-insert-directory-program nil
          dired-hide-details-hide-symlink-targets nil)

    (add-hook 'dired-mode-hook 'dired-hide-details-mode))
#+END_SRC

** Editing
*** Alarms Bell

关闭警报声

#+BEGIN_SRC emacs-lisp
  (setq ring-bell-function 'ignore)
#+END_SRC

*** Dialog

#+BEGIN_SRC emacs-lisp
  (setq use-dialog-box nil
        use-file-dialog nil)
#+END_SRC

*** Echo Area

#+BEGIN_SRC emacs-lisp
  (setq echo-keystrokes .01)
#+END_SRC

*** Final Newline

#+BEGIN_SRC emacs-lisp
  (setq require-final-newline t)
#+END_SRC

*** Scrolling

#+BEGIN_SRC emacs-lisp
  (setq scroll-margin 1
        scroll-conservatively 10000
        scroll-preserve-screen-position t)
#+END_SRC

*** Tabs

不使用 tab

#+BEGIN_SRC emacs-lisp
  (setq-default indent-tabs-mode nil)
#+END_SRC

*** Truncate Lines

#+BEGIN_SRC emacs-lisp
  (set-default 'truncate-lines t)
#+END_SRC

*** Whitespace

#+BEGIN_SRC emacs-lisp
  (use-package whitespace
    :defer t
    :diminish whitespace-mode
    :config
    (setq whitespace-style '(face empty tabs trailing))
    (add-hook 'before-save-hook 'whitespace-cleanup))
#+END_SRC

*** Yes Or No P

#+BEGIN_SRC emacs-lisp
  (defalias 'yes-or-no-p 'y-or-n-p)
#+END_SRC

** Encoding

使用 utf-8

#+BEGIN_SRC emacs-lisp
  (prefer-coding-system 'utf-8)
#+END_SRC

** Initial

#+BEGIN_SRC emacs-lisp
  (setq inhibit-startup-screen t
        initial-scratch-message ""
        initial-major-mode 'text-mode)
#+END_SRC

** Ibuffer

#+BEGIN_SRC emacs-lisp
  (use-package ibuffer
    :bind ("C-x C-b" . ibuffer))
#+END_SRC

** Minibuffer

[[http://bling.github.io/blog/2016/01/18/why-are-you-changing-gc-cons-threshold/][为什么这么做]]

#+BEGIN_SRC emacs-lisp
  (add-hook 'minibuffer-setup-hook
            (lambda ()
              (setq gc-cons-threshold most-positive-fixnum)))

  (add-hook 'minibuffer-exit-hook
            (lambda ()
              (setq gc-cons-threshold 800000)))
#+END_SRC

** PATH

#+BEGIN_SRC emacs-lisp
  (setenv "PATH" (concat (getenv "PATH") ":/usr/local/bin"))
  (setq exec-path (append exec-path '("/usr/local/bin")))
#+END_SRC

** Uniquify

#+BEGIN_SRC emacs-lisp
  (use-package uniquify
    :config
    (setq uniquify-buffer-name-style 'forward))
#+END_SRC

** Server

#+BEGIN_SRC emacs-lisp
  (use-package server
    :config
    (unless (server-running-p)
      (server-start)))
#+END_SRC

* External Packages

** Editing

*** Iedit

#+BEGIN_SRC emacs-lisp
  (use-package iedit
    :defer t
    :ensure t
    :commands iedit-mode
    :bind ("C-;" . iedit-mode))
#+END_SRC

*** Undo Tree

#+BEGIN_SRC emacs-lisp
  (use-package undo-tree
    :ensure t
    :diminish undo-tree-mode)
#+END_SRC

*** SmartParens

#+BEGIN_SRC emacs-lisp
  (use-package smartparens-config
    :ensure smartparens
    :diminish smartparens-mode
    :config
    (show-smartparens-global-mode)

    (sp-with-modes 'web-mode
      (sp-local-pair "{ " " }")
      (sp-local-pair "<% " " %>")
      (sp-local-pair "<%= "  " %>")))
#+END_SRC

** ESUP

#+BEGIN_SRC emacs-lisp
  (use-package esup :defer t :ensure t)
#+END_SRC

** Interface Enhancement

*** Counsel

#+BEGIN_SRC emacs-lisp
  (use-package counsel
    :ensure t
    :bind (("M-x" . counsel-M-x)
           ("C-s" . counsel-grep-or-swiper))
    :config
    (setq counsel-grep-base-command
          "rg -i -M 120 --no-heading --line-number --color never '%s' %s"))
#+END_SRC

*** Hydra

#+BEGIN_SRC emacs-lisp
  (use-package hydra
    :defer t
    :ensure t)
#+END_SRC

*** Ivy

#+BEGIN_SRC emacs-lisp
  (use-package ivy
    :ensure t
    :diminish ivy-mode
    :config
    (ivy-mode +1))
#+END_SRC

*** Swiper

#+BEGIN_SRC emacs-lisp
  (use-package swiper
    :ensure t
    :bind ("C-s" . swiper))
#+END_SRC

** Visual

*** Rainbow Delimiters
#+BEGIN_SRC emacs-lisp
  (use-package rainbow-delimiters :defer t :ensure t)
#+END_SRC

*** Theme

#+BEGIN_SRC emacs-lisp
  (use-package doom-themes
    :ensure t
    :config
    (setq doom-themes-enable-bold t
          doom-themes-enable-italic t)

    (load-theme 'doom-nova t))
#+END_SRC

* Programming

** Auto Complete

*** Company

#+BEGIN_SRC emacs-lisp
  (use-package company
    :ensure t
    :diminish company-mode
    :config
    (global-company-mode)

    (setq company-idle-delay 0.1
          company-minimum-prefix-length 2
          company-begin-commands '(self-insert-command))

    (bind-keys
     :map global-map
     ("C-i" . company-indent-or-complete-common)
     :map company-active-map
     ("C-n" . company-select-next)
     ("C-p" . company-select-previous)))
#+END_SRC

** Flycheck

#+BEGIN_SRC emacs-lisp
  (use-package flycheck :defer t :ensure t)
#+END_SRC

** Languages

*** CSS

**** CSS Mode

#+BEGIN_SRC emacs-lisp
  (use-package css-mode
    :defer t
    :config (setq css-indent-offset 2))
#+END_SRC

**** SASS Mode

#+BEGIN_SRC emacs-lisp
  (use-package sass-mode
    :ensure t
    :mode ("\\.sass\\'" . sass-mode))
#+END_SRC

**** SCSS Mode

#+BEGIN_SRC emacs-lisp
  (use-package scss-mode
    :ensure t
    :mode ("\\.scss\\'" . scss-mode)
    :config (setq scss-compile-at-save nil))
#+END_SRC

*** Javascript

**** NVM

#+BEGIN_SRC emacs-lisp
  (use-package nvm
    :ensure t
    :config (nvm-use (caar (last (nvm--installed-versions)))))
#+END_SRC

**** JS2 Mode

#+BEGIN_SRC emacs-lisp
  (use-package js2-mode
    :ensure t
    :interpreter (("node" . js2-mode))
    :config
    (setq-default js2-indent-level 2)

    (setq js-indent-level 2
          js2-basic-offset 2
          js2-mode-show-parse-errors nil
          js2-mode-show-strict-warnings nil))
#+END_SRC

**** Tern

#+BEGIN_SRC emacs-lisp
  (use-package tern
    :defer t
    :ensure t
    :config
    (use-package company-tern :ensure t)
    (add-to-list 'company-backends 'company-tern))
#+END_SRC

**** Rjsx Mode

#+BEGIN_SRC emacs-lisp
  (use-package rjsx-mode
    :ensure t
    :mode ("\\.js\\'" . rjsx-mode)
    :config
    (add-hook 'rjsx-mode-hook 'tern-mode))
#+END_SRC

*** JSON

#+BEGIN_SRC emacs-lisp
  (use-package json-mode
    :ensure t
    :mode ("\\.json\\'" . json-mode)
    :config
    (add-hook 'json-mode-hook
              (lambda ()
                (setq js-indent-level 2
                      json-reformat:indent-width 2
                      json-reformat:pretty-string? t))))
#+END_SRC

*** Lua

#+BEGIN_SRC emacs-lisp
  (use-package lua-mode
    :ensure t
    :defer t
    :mode ("\\.lua$'" . lua-mode)
    :interpreter ("lua" . lua-mode))
#+END_SRC

*** Ruby

**** Chruby

#+BEGIN_SRC emacs-lisp
  (use-package chruby :defer t :ensure t)
#+END_SRC

**** Inf Ruby

#+BEGIN_SRC emacs-lisp
  (use-package inf-ruby
    :defer t
    :ensure t)
#+END_SRC

**** Ruby Mode

#+BEGIN_SRC emacs-lisp
  (use-package ruby-mode
    :interpreter "ruby"
    :config
    (setq ruby-insert-encoding-magic-comment nil)

    (add-hook 'ruby-mode-hook
              (lambda ()
                (chruby "2.3")
                (flycheck-mode)
                (inf-ruby-minor-mode))))
#+END_SRC

*** Web

**** Web Mode

#+BEGIN_SRC emacs-lisp
  (use-package web-mode
    :ensure t
    :mode (("\\.html\\'" . web-mode)
           ("\\.erb\\'" . web-mode))
    :config
    (setq web-mode-style-padding 2
          web-mode-script-padding 2
          web-mode-css-indent-offset 2
          web-mode-attr-indent-offset 2
          web-mode-code-indent-offset 2
          web-mode-markup-indent-offset 2
          web-mode-enable-auto-pairing nil
          web-mode-enable-auto-indentation nil         ;; 粘贴的时候不要格式化代码
          web-mode-enable-current-element-highlight t
          web-mode-enable-current-column-highlight t))

#+END_SRC

**** Emmet

#+BEGIN_SRC emacs-lisp
  (use-package emmet-mode
    :ensure t
    :config
    (add-hook 'web-mode-hook 'emmet-mode)
    (add-hook 'sgml-mode-hook 'emmet-mode)
    (add-hook 'css-mode-hook 'emmet-mode))
#+END_SRC

*** YAML

#+BEGIN_SRC emacs-lisp
  (use-package yaml-mode
    :ensure t
    :mode ("\\.yml\\'" . yaml-mode))
#+END_SRC

** Prog Mode

#+BEGIN_SRC emacs-lisp
  (add-hook 'prog-mode-hook
            (lambda ()
              (display-line-numbers-mode +1)
              (rainbow-delimiters-mode +1)
              (smartparens-mode +1)
              (whitespace-mode +1)))
#+END_SRC

** Project Management

*** Projectile

#+BEGIN_SRC emacs-lisp
  (use-package projectile
    :defer t
    :ensure t
    :bind-keymap ("C-c p" . projectile-command-map)
    :init
    (setq projectile-completion-system 'ivy)
    :config
    (setq projectile-mode-line nil)
    (projectile-mode))
#+END_SRC

*** Projectile Rails

#+BEGIN_SRC emacs-lisp
  (use-package projectile-rails
    :ensure t
    :bind-keymap ("C-c r" . projectile-rails-command-map)
    :config
    (add-hook 'projectile-mode-hook 'projectile-rails-on))
#+END_SRC

** Search

*** Ripgrep

#+BEGIN_SRC emacs-lisp
  (use-package ripgrep :defer t :ensure t)
  (use-package projectile-ripgrep
    :ensure t
    :commands projectile-ripgrep)
#+END_SRC

*** Wgrep

#+BEGIN_SRC emacs-lisp
  (use-package wgrep :defer t :ensure t)
#+END_SRC

** Version Control

*** Magit

#+BEGIN_SRC emacs-lisp
  (use-package magit :defer t :ensure t)
#+END_SRC

*** Git Gutter Fringe

#+BEGIN_SRC emacs-lisp
  (use-package git-gutter-fringe
    :ensure t
    :diminish git-gutter-mode
    :config
    (global-git-gutter-mode +1)

    (setq-default fringes-outside-margins t)
    (fringe-helper-define 'git-gutter-fr:added '(center repeated)
                          "XXX.....")
    (fringe-helper-define 'git-gutter-fr:modified '(center repeated)
                          "XXX.....")
    (fringe-helper-define 'git-gutter-fr:deleted 'bottom
                          "X......."
                          "XX......"
                          "XXX....."
                          "XXXX...."))
#+END_SRC

* Vim Emulation

** Evil

#+BEGIN_SRC emacs-lisp
  (use-package evil
    :ensure t
    :config
    (evil-mode +1)

    (setcdr evil-insert-state-map nil)
    (bind-keys
     :map evil-insert-state-map
     ([escape] . evil-normal-state)
     ((read-kbd-macro evil-toggle-key) . evil-emacs-state)))
#+END_SRC

* Org

** Org Mode
#+BEGIN_SRC emacs-lisp
  (use-package org
    :defer t
    :ensure org-plus-contrib
    :pin org
    :config
    (setq org-startup-indented t
          org-src-fontify-natively t)

    (dolist (face '(org-level-1
                    org-level-2
                    org-level-3
                    org-level-4
                    org-level-5))
      (set-face-attribute face nil :weight 'semi-bold :height 1.0)))
#+END_SRC

* Note

** htmlize

#+BEGIN_SRC emacs-lisp
  (use-package htmlize
    :defer t
    :ensure t
    :config
    (setq htmlize-html-charset "utf-8"))
#+END_SRC

** ox publish

#+BEGIN_SRC emacs-lisp
  (use-package ox-publish
    :defer t
    :commands (org-publish-project publish-blog)
    :config
    (defun publish-blog()
      "publish my blog"
      (interactive)
      (org-publish-project "blog"))

    (defun read-html-template (template-file)
      (with-temp-buffer
        (insert-file-contents template-file)
        (buffer-string)))

    (setq
     org-publish-use-timestamps-flag nil

     org-export-with-section-numbers nil  ;; 去掉编号
     org-export-with-toc nil              ;; 关闭 TOC

     org-html-divs '((preamble "header" "top")
                     (content "main" "content")
                     (postamble "footer" "postamble"))

     org-html-postamble nil
     org-html-html5-fancy t
     org-html-doctype "html5"
     org-html-container-element "section"
     org-html-head-include-scripts nil        ;; 去掉默认的 script
     org-html-head-include-default-style nil  ;; 去掉默认的 css
     org-html-metadata-timestamp-format "%Y-%m-%d")

    (setq blog-html-head (read-html-template "~/Dropbox/Blog/include/head.html"))
    (setq blog-html-preamble (read-html-template "~/Dropbox/Blog/include/nav.html"))

    (setq org-publish-project-alist
          `(("blog" :components ("blog-notes" "blog-pages" "blog-assets"))

            ("blog-notes"
             :base-extension "org"
             :base-directory "~/Dropbox/Blog/notes"
             :publishing-directory "~/Blog/"
             :publishing-function org-html-publish-to-html

             :html-head ,blog-html-head
             :html-preamble ,blog-html-preamble

             :auto-sitemap t
             :sitemap-title "Blog"
             :sitemap-filename "index.org"
             :sitemap-file-entry-format "%d » [%t]"
             :sitemap-function org-publish-org-sitemap)

            ("blog-pages"
             :base-extension "org"
             :base-directory "~/Dropbox/Blog/pages"
             :publishing-directory "~/Blog/"
             :publishing-function org-html-publish-to-html

             :html-head ,blog-html-head
             :html-preamble ,blog-html-preamble)

            ("emacs"
             :base-extension "org"
             :base-directory "~/.emacs.d/"
             :publishing-directory "~/Blog/pages"
             :publishing-function org-html-publish-to-html

             :html-head ,blog-html-head
             :html-preamble ,blog-html-preamble)

            ("blog-assets"
             :base-extension "css\\|js"
             :base-directory "~/Dropbox/Blog/"
             :publishing-directory "~/Blog/"
             :publishing-function org-publish-attachment

             :recursive t))))
#+END_SRC

** Deft

#+BEGIN_SRC emacs-lisp
  (use-package deft
    :defer t
    :ensure t
    :commands deft
    :config
    (setq deft-recursive t
          deft-extensions '("org")
          deft-directory "~/Dropbox/Notes"))
#+END_SRC
