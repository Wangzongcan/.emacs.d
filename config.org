#+TITLE: emacs config
#+STARTUP: overview indent align
#+OPTIONS: ^:nil

* Base                                                                 :base:
** 载入 cl

#+BEGIN_SRC emacs-lisp
  (eval-when-compile (require 'cl))
#+END_SRC
** Encoding
#+BEGIN_SRC emacs-lisp
  (set-terminal-coding-system 'utf-8)
  (set-keyboard-coding-system 'utf-8)
  (set-language-environment "UTF-8")
  (prefer-coding-system 'utf-8)
#+END_SRC
** General Settings

#+BEGIN_SRC emacs-lisp
  (setq
   inhibit-startup-message t
   initial-scratch-message ""
   visible-bell t
   ring-bell-function #'ignore
   backup-directory-alist `((".*" . ,temporary-file-directory)) ;don't clutter my fs and put backups into tmp
   auto-save-file-name-transforms `((".*" ,temporary-file-directory t))
   require-final-newline t                ;auto add newline at the end of file
   column-number-mode t                   ;show the column number
   default-major-mode 'text-mode          ;use text mode per default
   mouse-yank-at-point t                  ;middle click with the mouse yanks at point
   history-length 250                     ;default is 30
   locale-coding-system 'utf-8            ;utf-8 is default
   tab-always-indent 'complete            ;try to complete before identing
   confirm-nonexistent-file-or-buffer nil ;don't ask to create a buffer
   vc-follow-symlinks t                   ;follow symlinks automatically
   recentf-max-saved-items 5000           ;same up to 5000 recent files
   eval-expression-print-length nil       ;do not truncate printed expressions
   eval-expression-print-level nil        ;print nested expressions
   send-mail-function 'sendmail-send-it
   kill-ring-max 5000                     ;truncate kill ring after 5000 entries
   mark-ring-max 5000                     ;truncate mark ring after 5000 entries
   mouse-wheel-scroll-amount '(1 ((shift) . 5) ((control))) ;make mouse scrolling smooth
   indicate-buffer-boundaries 'left       ;fringe markers
   split-height-threshold 110             ;more readily split horziontally
   enable-recursive-minibuffers t
   custom-unlispify-menu-entries nil      ;M-x customize should not cripple menu entries
   custom-unlispify-tag-names nil         ;M-x customize should not cripple tags
   show-paren-delay 0
   default-truncate-lines t
   echo-keystrokes 0.1
   )

  (put 'narrow-to-region 'disabled nil)
#+END_SRC
** Default Settings
#+BEGIN_SRC emacs-lisp
  (setq-default
   tab-width 4
   indent-tabs-mode nil                   ;use spaces instead of tabs
   c-basic-offset 4                       ;"tab" with in c-related modes
   c-hungry-delete-key t                  ;delete more than one space
  )
#+END_SRC
** Global Modes
#+BEGIN_SRC emacs-lisp
  (global-auto-revert-mode 1)  ;auto revert buffers when changed on disk
  (show-paren-mode t)          ;visualize()
  (blink-cursor-mode -1)       ;no cursor blinking
  (tool-bar-mode -1)           ;disable the awful toolbar
  (menu-bar-mode 1)            ;no menu, you can toggle it with C-c m
  (scroll-bar-mode -1)         ;disable the sroll bar
  (global-font-lock-mode t)
  (transient-mark-mode t)
#+END_SRC
** Yes or No
#+BEGIN_SRC emacs-lisp
  (fset 'yes-or-no-p 'y-or-n-p)
#+END_SRC
* Functions                                                       :functions:
** load init.el
#+BEGIN_SRC emacs-lisp
  (defun load-init-file()
    (interactive)
    (load-file "~/.emacs.d/init.el"))
#+END_SRC
** edit config.org
#+BEGIN_SRC emacs-lisp
  ;; 编辑 config.org
  (defun edit-config-file ()
    "edit config.org."
    (interactive)
    (find-file config-file))
#+END_SRC
* Font                                                                 :font:
字体设置
#+BEGIN_SRC emacs-lisp
  ;; 英文字体
  (set-frame-font "Monaco:pixelsize=13")

  ;; 中文字体
  (dolist (charset '(kana han symbol cjk-misc bopomofo))
    (set-fontset-font (frame-parameter nil 'font)
                      charset
                      (font-spec :family "Hiragino Sans GB W3" :size 16)))
#+END_SRC
* Theme                                                               :theme:
** Settings
#+BEGIN_SRC emacs-lisp
  (load-theme 'monokai t)
#+END_SRC
* Evil                                                                 :evil:
** Settings
载入 evil
#+BEGIN_SRC emacs-lisp
  (require 'evil)
#+END_SRC

开启 evil-mode
#+BEGIN_SRC emacs-lisp
  (evil-mode 1)
#+END_SRC

插入模式时绑定 emacs 按键，ESC 返回普通模式
#+BEGIN_SRC emacs-lisp
  (setcdr evil-insert-state-map nil)
  (define-key evil-insert-state-map
    (read-kbd-macro evil-toggle-key) 'evil-emacs-state)

  (define-key evil-insert-state-map[escape] 'evil-normal-state)
#+END_SRC
** evil-define-key
*** normal mode

普通模式
#+BEGIN_SRC emacs-lisp
  (evil-define-key 'normal global-map (kbd "j") (kbd "gj"))
  (evil-define-key 'normal global-map (kbd "k") (kbd "gk"))
#+END_SRC

** evil-ex-define-cmd
#+BEGIN_SRC emacs-lisp
  (evil-ex-define-cmd "q" 'kill-this-buffer)
  (evil-ex-define-cmd "wq" 'save-and-kill-this-buffer)
#+END_SRC
** evil-set-initial-state
#+BEGIN_SRC emacs-lisp
  (evil-set-initial-state 'dired-mode 'emacs)
  (evil-set-initial-state 'ibuffer-mode 'emacs)
  (evil-set-initial-state 'makey-key-mode 'emacs)
  (evil-set-initial-state 'inf-ruby-mode 'emacs)
  (evil-set-initial-state 'git-commit-mode 'emacs)
#+END_SRC
** evil-cursor
#+BEGIN_SRC emacs-lisp
  (setq evil-emacs-state-cursor '("red" box))
  (setq evil-normal-state-cursor '("green" box))
  (setq evil-visual-state-cursor '("orange" box))
#+END_SRC
* Evil-leader                                                   :evil:leader:
** Settings

载入 evil-leader
#+BEGIN_SRC emacs-lisp
  (require 'evil-leader)
#+END_SRC

设置  leader key
#+BEGIN_SRC emacs-lisp
  (evil-leader/set-leader "<SPC>")
#+END_SRC

开启
#+BEGIN_SRC emacs-lisp
  (global-evil-leader-mode)
#+END_SRC

#+BEGIN_SRC emacs-lisp
  (evil-leader/set-key
    "0" 'delete-window
    "1" 'delete-other-windows
    "2" 'split-window-below
    "3" 'split-window-right
    "ee" 'edit-config-file
    "ll" 'load-init-file
    "o" 'ace-window)
#+END_SRC
** projectile
#+BEGIN_SRC emacs-lisp
  (eval-after-load "projectile-autoloads"
    '(progn
       (evil-leader/set-key
         "pa" 'projectile-ag
         "pb" 'projectile-switch-to-buffer
         "pf" 'projectile-find-file
         "pp" 'projectile-switch-project)))
#+END_SRC
** helm
#+BEGIN_SRC emacs-lisp
  (eval-after-load "helm-autoloads"
    '(progn
       (evil-leader/set-key
         "b" 'helm-buffers-list)))
#+END_SRC
** git
*** magit
#+BEGIN_SRC emacs-lisp
  (eval-after-load "magit-autoloads"
    '(progn
       (evil-leader/set-key
         "gs" 'magit-status)))
#+END_SRC
*** git-gutter
#+BEGIN_SRC emacs-lisp
  (eval-after-load "git-gutter-autoloads"
    '(progn
       (evil-leader/set-key
         "gg" 'git-gutter)))
#+END_SRC
** rails
#+BEGIN_SRC emacs-lisp
  (eval-after-load "projectile-rails-autoloads"
    '(progn
       (evil-leader/set-key
         "rc" 'projectile-rails-find-controller
         "rC" 'projectile-rails-find-current-controller
         "rm" 'projectile-rails-find-model
         "rM" 'projectile-rails-find-current-model
         "rh" 'projectile-rails-find-helper
         "rH" 'projectile-rails-find-current-helper
         "rv" 'projectile-rails-find-view
         "rV" 'projectile-rails-find-current-view)))
#+END_SRC
* Dired                                                               :dired:
** Settings
#+BEGIN_SRC emacs-lisp
  (require 'dired+)
  (require 'dired-single)
#+END_SRC

#+BEGIN_SRC emacs-lisp
  (setq dired-single-use-magic-buffer t
        dired-single-magic-buffer-name "*dired*")
  (setq dired-use-ls-dired nil)
#+END_SRC
** define-key
#+BEGIN_SRC emacs-lisp
  (define-key dired-mode-map (kbd "RET") 'dired-single-buffer)
  (define-key dired-mode-map (kbd "<mouse-1>") 'dired-single-buffer-mouse)
  (define-key dired-mode-map (kbd "C-l")
    (lambda ()
      (interactive)
      (dired-single-buffer "..")))
#+END_SRC
** add-hook
#+BEGIN_SRC emacs-lisp
  (add-hook 'dired-mode-hook
            '(lambda ()
               (dired-single-toggle-buffer-name)))
#+END_SRC
* Org-mode                                                              :org:
** Settings
设置
#+BEGIN_SRC emacs-lisp
  (setq org-startup-indented t
        org-startup-folded t
        org-hide-leading-starts t
        org-src-fontify-natively t
        org-src-window-setup 'current-window)
#+END_SRC

#+BEGIN_SRC emacs-lisp
  (custom-set-faces
   '(org-document-title ((t (:inherit font-lock-preprocessor-face :height 1.0 :weight bold))))
   '(org-level-1 ((t (:inherit outline-1 :height 1.0))))
   '(org-level-2 ((t (:inherit outline-2 :height 1.0))))
   '(org-level-3 ((t (:inherit outline-3 :height 1.0))))
   '(org-level-4 ((t (:inherit outline-4 :height 1.0))))
   '(org-level-5 ((t (:inherit outline-5 :height 1.0))))
   )
#+END_SRC
* Helm                                                                :helm:
** Settings
载入 helm
#+BEGIN_SRC emacs-lisp
  (require 'helm)
  (require 'helm-config)
#+END_SRC

#+BEGIN_SRC emacs-lisp
  (setq helm-split-window-in-side-p           t ; open helm buffer inside current window, not occupy whole other window
        helm-ff-search-library-in-sexp        t ; search for library in `require' and `declare-function' sexp.
        helm-scroll-amount                    8 ; scroll 8 lines other window using M-<next>/M-<prior>
        helm-M-x-fuzzy-match                  t
        helm-buffers-fuzzy-matching           t
        helm-imenu-fuzzy-match                t
        helm-ff-file-name-history-use-recentf t)
#+END_SRC

autoresize
#+BEGIN_SRC emacs-lisp
  (helm-autoresize-mode t)
#+END_SRC

** global-set-key
#+BEGIN_SRC emacs-lisp
  (global-set-key (kbd "M-x") 'helm-M-x)
  (global-set-key (kbd "M-y") 'helm-show-kill-ring)
  (global-set-key (kbd "C-x b") 'helm-buffers-list)
  (global-set-key (kbd "C-x C-f") 'helm-find-files)
#+END_SRC

** define-key
#+BEGIN_SRC emacs-lisp
  (define-key helm-map (kbd "<tab>") 'helm-execute-persistent-action)
#+END_SRC

** start
#+BEGIN_SRC emacs-lisp
  (helm-mode 1)
#+END_SRC
* Helm-swoop                                                     :helm:swoop:
** Settings
载入
#+BEGIN_SRC emacs-lisp
  (require 'helm-swoop)
#+END_SRC
** global-set-key
#+BEGIN_SRC emacs-lisp
  (global-set-key (kbd "M-i") 'helm-swoop)
  (global-set-key (kbd "M-I") 'helm-swoop-back-to-last-point)
  (global-set-key (kbd "C-c M-i") 'helm-multi-swoop)
  (global-set-key (kbd "C-x M-i") 'helm-multi-swoop-all)
#+END_SRC
* Git                                                                   :git:
** git-gutter
*** Settings
载入
#+BEGIN_SRC emacs-lisp
  (require 'git-gutter)
#+END_SRC

#+BEGIN_SRC emacs-lisp
  (global-git-gutter-mode +1)
#+END_SRC
** git-gutter-fringe
*** Settings
载入
#+BEGIN_SRC emacs-lisp
  (require 'git-gutter-fringe)
#+END_SRC
* Company                                                           :company:
** Settings
载入 company
#+BEGIN_SRC emacs-lisp
  (require 'company)
#+END_SRC

开启
#+BEGIN_SRC emacs-lisp
  (add-hook 'after-init-hook 'global-company-mode)
#+END_SRC

设置
#+BEGIN_SRC emacs-lisp
  (setq company-auto-complete nil
        company-idle-delay nil
        company-minimum-prefix-length 1
        company-tooltip-limit 30)
#+END_SRC

#+BEGIN_SRC emacs-lisp
  (defun complete-or-indent ()
    "Either indent or complete at point."
    (interactive)
    (if (looking-at "\\_>")
        (company-complete-common)
      (indent-according-to-mode)))
#+END_SRC
** global-set-key
#+BEGIN_SRC emacs-lisp
  (global-set-key (kbd "TAB") 'complete-or-indent)
#+END_SRC
** define-key
#+BEGIN_SRC emacs-lisp
  (define-key company-active-map (kbd "C-n") 'company-select-next)
  (define-key company-active-map (kbd "C-p") 'company-select-previous)
#+END_SRC

* Yasnippet                                                         :snippet:
** Settings
载入
#+BEGIN_SRC emacs-lisp
    (require 'yasnippet)
#+END_SRC

#+BEGIN_SRC emacs-lisp
  (yas-global-mode 1)
#+END_SRC
* Projectile                                                     :projectile:
** Settings
载入 projectile
#+BEGIN_SRC emacs-lisp
  (require 'projectile)
#+END_SRC

开启 projectile
#+BEGIN_SRC emacs-lisp
  (projectile-global-mode)
#+END_SRC

补全用 helm
#+BEGIN_SRC emacs-lisp
  (setq projectile-completion-system 'helm)
#+END_SRC
** add-hook
#+BEGIN_SRC emacs-lisp
  (add-hook 'projectile-mode-hook 'projectile-rails-on)
#+END_SRC
* Flycheck                                                         :flycheck:
** Settings
#+BEGIN_SRC emacs-lisp
  (require 'flycheck)
#+END_SRC
** add-hook
#+BEGIN_SRC emacs-lisp
  (add-hook 'after-init-hook #'global-flycheck-mode)
#+END_SRC
* Smart-mode-line                                                  :modeline:
** Settings
载入 smart-mode-line
#+BEGIN_SRC emacs-lisp
  (require 'smart-mode-line)
#+END_SRC

设置
#+BEGIN_SRC emacs-lisp
  (setq sml/theme 'respectful
        sml/no-confirm-load-theme t
        sml/mode-width 'full
        sml/shorten-modes t
        sml/shorten-directory t
        sml/name-width 20)

  (sml/setup)
#+END_SRC
* Whitespace                                                     :whitespace:
** Settings
开启 whitespace
#+BEGIN_SRC emacs-lisp
  (global-whitespace-mode 1)
#+END_SRC

whitespace style
#+BEGIN_SRC emacs-lisp
  (setq whitespace-style
        '(face tabs trailing tab-mark newline newline-mark))
#+END_SRC

mappings
#+BEGIN_SRC emacs-lisp
  (setq whitespace-display-mappings
        '((spaces-mark 32 [32] [183] [46])
          (tab-mark 9 [187 32 32 32])))
#+END_SRC
* Smartparens                                                   :smartparens:
** Settings
载入 smartparens
#+BEGIN_SRC emacs-lisp
  (require 'smartparens)
  (require 'smartparens-config)
#+END_SRC

开启
#+BEGIN_SRC emacs-lisp
  (smartparens-global-mode t)
  (show-smartparens-global-mode t)
#+END_SRC

跳过一些 mode
#+BEGIN_SRC emacs-lisp
  (setq sp-ignore-modes-list '(minibuffer-inactive-mode
                               web-mode))
#+END_SRC
* Ibuffer                                                           :ibuffer:
** Settings
载入 ibuffer
#+BEGIN_SRC emacs-lisp
  (require 'ibuffer)
#+END_SRC

载入 ibuffer-vc
#+BEGIN_SRC emacs-lisp
  (require 'ibuffer-projectile)
#+END_SRC

载入 ibuf-ext
#+BEGIN_SRC emacs-lisp
  (require 'ibuf-ext)
#+END_SRC

设置
#+BEGIN_SRC emacs-lisp
  (setq ibuffer-expert t
        ibuffer-show-empty-filter-groups nil)
#+END_SRC

不显示的 buffer
#+BEGIN_SRC emacs-lisp
  (add-to-list 'ibuffer-never-show-predicates "^\\*ag")
  (add-to-list 'ibuffer-never-show-predicates "^\\*helm")
  (add-to-list 'ibuffer-never-show-predicates "^\\*magit")
#+END_SRC

** size
#+BEGIN_SRC emacs-lisp
  (define-ibuffer-column size-h
    (:name "Size" :inline t)
    (cond
     ((> (buffer-size) 1000000)
      (format "%7.1fM" (/ (buffer-size) 1000000.0)))
     ((> (buffer-size) 1000)
      (format "%3.1fK" (/ (buffer-size) 1000.0)))
     (t
      (format "%3d" (buffer-size)))))
#+END_SRC
** format
#+BEGIN_SRC emacs-lisp
  (setq ibuffer-formats
        '((mark modified read-only
                " "
                (name 18 28 :center :elide)
                " "
                (size-h 9 -1 :right)
                " "
                (mode 18 18 :left :elide)
                " "
                filename-and-process)))
#+END_SRC
** global-set-key
#+BEGIN_SRC emacs-lisp
  (global-set-key (kbd "C-x C-b") 'ibuffer)
#+END_SRC
** add-hook
#+BEGIN_SRC emacs-lisp
  (add-hook 'ibuffer-hook
            (lambda ()
              (ibuffer-projectile-set-filter-groups)
              (unless (eq ibuffer-sorting-mode 'alphabetic)
                (ibuffer-do-sort-by-alphabetic))))

#+END_SRC
* Imenu                                                               :imenu:
** Settings
#+BEGIN_SRC emacs-lisp
  (require 'imenu)
#+END_SRC

#+BEGIN_SRC emacs-lisp
  (setq imenu-auto-rescan t)
#+END_SRC
* Rainbow-delimiters                                                :rainbow:
** Settings
载入
#+BEGIN_SRC emacs-lisp
  (require 'rainbow-delimiters)
#+END_SRC
** add-hook
#+BEGIN_SRC emacs-lisp
  (add-hook 'prog-mode-hook #'rainbow-delimiters-mode)
#+END_SRC
* Ace-window                                                     :ace:window:
** Settings

载入
#+BEGIN_SRC emacs-lisp
  (require 'ace-window)
#+END_SRC

设置
#+BEGIN_SRC emacs-lisp
(setq aw-keys '(?a ?s ?d ?f ?g ?h ?j ?k ?l))
#+END_SRC
** global-set-key
#+BEGIN_SRC emacs-lisp
  (global-set-key (kbd "C-x o") 'ace-window)
#+END_SRC
* Quickrun                                                         :quickrun:
** Settings
#+BEGIN_SRC emacs-lisp
  (require 'quickrun)
#+END_SRC
* Rvm                                                                   :rvm:
** Settings
载入 rvm
#+BEGIN_SRC emacs-lisp
  (require 'rvm)
#+END_SRC

使用默认
#+BEGIN_SRC emacs-lisp
  (rvm-use-default)
#+END_SRC
* Ruby                                                                 :ruby:
** Settings
载入
#+BEGIN_SRC emacs-lisp
  (autoload 'ruby-mode "ruby-mode" "" t)
#+END_SRC

设置
#+BEGIN_SRC emacs-lisp
  (setq ruby-insert-encoding-magic-comment nil)
#+END_SRC

** add-to-list
#+BEGIN_SRC emacs-lisp
  (add-to-list 'auto-mode-alist '("\\.rake$" . ruby-mode))
  (add-to-list 'auto-mode-alist '("Gemfile$" . ruby-mode))
  (add-to-list 'interpreter-mode-alist '("ruby" . ruby-mode))
#+END_SRC

** add-hook
#+BEGIN_SRC emacs-lisp
  (add-hook 'ruby-mode-hook
            '(lambda ()
               '(progn
                  (setq tab-width 2
                        ruby-indent-level tab-width))))
#+END_SRC
* Web                                                                   :web:
** Settings
载入 web-mode
#+BEGIN_SRC emacs-lisp
  (require 'web-mode)
#+END_SRC

setq-default
#+BEGIN_SRC emacs-lisp
  (setq-default
   web-mode-markup-indent-offset 2
   web-mode-markup-indent-offset 2
   web-mode-css-indent-offset 2
   web-mode-code-indent-offset 2
   web-mode-script-padding 2)
#+END_SRC

** add-to-list
#+BEGIN_SRC emacs-lisp
  (add-to-list 'auto-mode-alist '("\\.html$" . web-mode))
  (add-to-list 'auto-mode-alist '("\\.erb$" . web-mode))
#+END_SRC
* Emmet                                                               :emmet:
** Settings
载入
#+BEGIN_SRC emacs-lisp
  (require 'emmet-mode)
#+END_SRC
** add-hook
#+BEGIN_SRC emacs-lisp
  (add-hook 'web-mode-hook 'emmet-mode)
  (add-hook 'css-mode-hook 'emmet-mode)
  (add-hook 'scss-mode-hook 'emmet-mode)
  (add-hook 'sass-mode-hook 'emmet-mode)
  (add-hook 'emmet-mode-hook (lambda () (setq emmet-indentation 2)))
#+END_SRC
* Nvm                                                                   :nvm:
** Settings

载入 nvm
#+BEGIN_SRC emacs-lisp
  (require 'nvm)
#+END_SRC
* Javascript                                                     :javascript:
** Settings
载入 js2-mode
#+BEGIN_SRC emacs-lisp
  (autoload 'js2-mode "js2-mode" nil t)
#+END_SRC

** add-to-list
#+BEGIN_SRC emacs-lisp
  (add-to-list 'auto-mode-alist '("\\.js$" . js2-mode))
#+END_SRC

** add-hook
#+BEGIN_SRC emacs-lisp
  (add-hook 'js2-mode-hook
            '(lambda ()
               (setq tab-width 2
                     js2-basic-offset tab-width)))
#+END_SRC
* Coffeescript                                                 :coffeescript:
** Settings
载入 coffee-mode
#+BEGIN_SRC emacs-lisp
  (require 'coffee-mode)
#+END_SRC

设置
#+BEGIN_SRC emacs-lisp
  (setq coffee-tab-width 2)
#+END_SRC
* Css                                                                   :css:
** Settings
#+BEGIN_SRC emacs-lisp
  (defvar css-indent-offset 2)
#+END_SRC
* Sass                                                                 :sass:
** Settings
载入 sass-mode
#+BEGIN_SRC emacs-lisp
  (autoload 'sass-mode "sass-mode")
#+END_SRC

** add-to-list
#+BEGIN_SRC emacs-lisp
  (add-to-list 'auto-mode-alist '("\\.sass$" . sass-mode))
#+END_SRC
* Scss                                                                 :scss:
** Settings
载入 scss-mode
#+BEGIN_SRC emacs-lisp
  (autoload 'scss-mode "scss-mode")
#+END_SRC

设置
#+BEGIN_SRC emacs-lisp
  (setq scss-compile-at-save nil)
#+END_SRC

** add-to-list
#+BEGIN_SRC emacs-lisp
  (add-to-list 'auto-mode-alist '("\\.scss$" . scss-mode))
#+END_SRC
* Yaml                                                                 :yaml:
** Settings
载入 yaml-mode
#+BEGIN_SRC emacs-lisp
  (require 'yaml-mode)
#+END_SRC

** add-to-list
#+BEGIN_SRC emacs-lisp
  (add-to-list 'auto-mode-alist '("\\.yml$" . yaml-mode))
#+END_SRC
